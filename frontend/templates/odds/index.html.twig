{% extends 'base.html.twig' %}

{% block title %}Odds List{% endblock %}

{% block body %}
<header>
    <div class="title-container">
        <img src="{{ asset('images/logo.png') }}" alt="Logo" class="site-logo">
        <h1>Benchmark</h1>
    </div>    
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}
</header>


<div class="container">
    <!-- aside for scraping -->
        <aside id="sidebar">
            <h3 class="sidebar-title">Scraping Filters</h3>
            {% if lastScrapingDate %}
                <div class="last-scraping-info">
                    <span class="last-scraping-label">Last scraping:</span>
                    <span class="last-scraping-date">{{ lastScrapingDate|date('d/m/Y H:i') }}</span>
                </div>
            {% endif %}

            <!-- Auto Scraping Toggle -->
            <div class="auto-scraping-control">
                <div class="auto-scraping-header">
                    <span class="auto-scraping-label">Auto Scraping (6h)</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-scraping-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="auto-scraping-status" id="auto-scraping-status">
                    <span class="status-indicator"></span>
                    <span class="status-text">Loading...</span>
                </div>
                <div class="next-run-info" id="next-run-info" style="display: none;">
                    <svg class="clock-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="next-run-text" id="next-run-text">Next: --:--</span>
                </div>
            </div>

            <form class="aside-form" id="scraping-form" method="post" action="{{ path('scraping_trigger') }}">
                <div class="form-group">
                    <label for="sport-scraping">Sport</label>
                    <select name="scraping_sport" id="sport-scraping" class="form-control" required>
                        <option value="">Choose</option>
                        <option value="football">Football</option>
                        <option value="basketball">Basketball</option>
                        <option value="rugby">Rugby</option>
                        <option value="tennis">Tennis</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="league-scraping">League</label>
                    <select name="scraping_league" id="league-scraping" class="form-control" required>

                    </select>
                </div>
                
                <button type="submit" class="scraping-btn" id="start-scraping-btn">
                    <span class="btn-text">Start Scraping</span>
                    <span class="btn-loader" style="display: none;">En cours...</span>
                </button>

                <button type="button" class="reset-scraping-btn" id="reset-scraping-btn" style="display: none;">
                    Reset Scraping
                </button>

                <!-- Progress bar -->
                <div id="scraping-progress" style="display: none;">
                    <div class="progress-header">
                        <h3>Scraping in progress...</h3>
                        <span class="progress-count" id="progress-count">0 / 0</span>
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar-fill">
                            <span class="progress-percentage" id="progress-percentage">0%</span>
                        </div>
                    </div>
                    
                    <div class="current-match-info">
                        <span id="current-match-name">Waiting...</span>
                    </div>
                </div>
            </form>
        </aside>
    <main>       
        <!-- filter by bookmaker, date & match -->
        <h2>Filters</h2>
        <div class="filter-form-container">
            {{ form_start(form, {'method': 'get', 'action': path('odds_list'), 'attr': {'class': 'form-filters', 'name': 'odds_filter'}}) }}
                <div class="form-group">
                    {{ form_label(form.sport) }}
                    {{ form_widget(form.sport) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.bookmaker) }}
                    {{ form_widget(form.bookmaker) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.league) }}
                    {{ form_widget(form.league) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.match) }}
                    {{ form_widget(form.match) }}
                </div>
                <div class="form-group">
                    {{ form_label(form.dateRange) }}
                    {{ form_widget(form.dateRange) }}
                </div>
                <div class="filter-buttons-group">
                    <button type="submit" id="filter-button" class="form-btn">Filter</button>
                    <button id="reset-btn" class="form-btn">Init</button>
                    <button type="button" id="export-csv-btn" class="form-btn export-btn">üìä Export CSV</button>
                </div>
            {{ form_end(form) }}
        </div>
        <button id="toggleSidebar" class="toggle-btn">‚ò∞ Scraping</button>
        <div class="tables">
            <!--table for trj by bookmakers-->
            <table class="avgtrj">
                <thead>
                    <tr>
                        <th>Bookmaker <span>‚¨ç</span></th>
                        <th>Average RTP <span>‚¨ç</span></th>
                        <th>Evolution  <span>‚¨ç</span></th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in avgTrj %}
                        <tr>


                            <td>{{ row.bookmaker }}</td>
                            <td class="{% if row.avgTrj > 90 %}trj-high{% elseif row.avgTrj < 90 %}trj-low{% endif %}">
                                {{ row.avgTrj|number_format(2, '.', '') }}%
                            </td>
                            <td class="evol-container">
                                <span>
                                {% if row.evolution == 1 %}
                                    <span class="arrow-up">‚Üë</span>
                                {% elseif row.evolution == -1 %}
                                    <span class="arrow-down">‚Üì</span>
                                {% else %}
                                    <span class="arrow-stable">‚Üí</span>
                                {% endif %}
                                </span>
                                <span class="previous-trj">{{ row.previousAvgTrj ? row.previousAvgTrj|number_format(2, '.', '') ~ '%' : '-' }}</span>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="4">No data found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- table for all matchs -->
            <table class="all_matchs">
                <thead>
                    <tr>
                        <th>Match <span>‚¨ç</span></th>
                        <th>Bookmaker <span>‚¨ç</span></th>
                        <th>Home <span>‚¨ç</span></th>
                        <th>Draw <span>‚¨ç</span></th>
                        <th>Away <span>‚¨ç</span></th>
                        <th>RTP <span>‚¨ç</span></th>
                        <th>Evol  <span>‚¨ç</span></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in odds %}
                        <tr>
                            <td>{{ item.odd.match.home_team.name }} - {{ item.odd.match.away_team.name }}</td>
                            <td>{{ item.odd.bookmaker.name }}</td>
                            <td>{{ item.odd.cote1|default('-') }}</td>
                            <td>{{ item.odd.coteN|default('-') }}</td>
                            <td>{{ item.odd.cote2|default('-') }}</td>
                            <td class="{% if item.odd.trj > 90 %}trj-high{% elseif item.odd.trj < 90 %}trj-low{% endif %}">
                                {{ item.odd.trj|number_format(2, '.', '') }}%
                            </td>
                            <td class="evol-container">
                                <span>{% if item.evolution == 1 %}
                                    <span class="arrow-up">‚Üë</span>
                                {% elseif item.evolution == -1 %}
                                    <span class="arrow-down">‚Üì</span>
                                {% else %}
                                    <span class="arrow-stable">‚Üí</span>
                                {% endif %}</span>
                                <span class="previous-trj">{{ item.previousTrj ? item.previousTrj|number_format(2, '.', '') ~ '%' : '-' }}</span>
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="7">No odds available.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </main>
</div>
<script id="leagues-data" type="application/json">
    {{ leaguesData|raw }}
</script>
<script id="matches-data" type="application/json">
    {{ matchesData|raw }}
</script>
{% endblock %}
